version: '3.8'
services:
    redis:
        container_name: redis
        hostname: redis
        image: redis:latest # Ensure this is compatible with your RDB file
        restart: unless-stopped
        command: ['redis-server', '--bind', 'redis', '--port', '6379']
        ports:
            - '${REDIS_PORT}:${REDIS_PORT}'
        networks:
            - ticketing-net
        extra_hosts:
            - host.docker.internal:host-gateway
        volumes:
            - redis-data:/data

    api:
        container_name: nestjs
        image: nestjs-dev
        restart: unless-stopped
        build:
            context: .
            dockerfile: Dockerfile
            target: dev
        environment:
            DB_TYPE: ${DB_TYPE}
            DB_HOST: database
            DB_PORT: ${DB_PORT}
            DB_USER_NAME: ${DB_USER_NAME}
            DB_PASSWORD: ${DB_PASSWORD}
            DATABASE: ${DATABASE}
            MAX_CONNECTIONS: ${MAX_CONNECTIONS}
            MAX_SEATS: ${MAX_SEATS}
            VALID_TOKEN_EXPIRATION_TIME: ${VALID_TOKEN_EXPIRATION_TIME}
            SEAT_HOLD_EXPIRATION_TIME: ${SEAT_HOLD_EXPIRATION_TIME}
            JWT_SECRET_KEY: ${JWT_SECRET_KEY}
            MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
            MYSQL_DATABASE: ${DATABASE}
            REDIS_HOST: redis
            REDIS_PORT: ${REDIS_PORT}
            KAFKA_HOST: kafka
        volumes:
            - .:/app
            - /app/node_modules
        ports:
            - '3000:3000'
        networks:
            - ticketing-net
        depends_on:
            - redis
        external_links:
            - redis
        command: pnpm run start

    database:
        container_name: mariadb
        image: mariadb:10.6
        restart: unless-stopped
        volumes:
            - mariadb-data:/var/lib/mysql
        environment:
            MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
            MYSQL_DATABASE: ${DATABASE}
        networks:
            - ticketing-net
        ports:
            - '3307:3306'

    zookeeper:
        image: confluentinc/cp-zookeeper:latest
        container_name: zookeeper
        restart: unless-stopped
        environment:
            ZOOKEEPER_CLIENT_PORT: 2181
            ZOOKEEPER_TICK_TIME: 2000
        ports:
            - '2181:2181'
        networks:
            - ticketing-net

    kafka:
        image: confluentinc/cp-kafka:latest
        container_name: kafka
        restart: unless-stopped
        ports:
            - '9092:9092'
        environment:
            KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
            KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
            KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
            KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
            KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
        networks:
            - ticketing-net
        depends_on:
            - zookeeper

networks:
    ticketing-net:
        driver: bridge

volumes:
    mariadb-data:
        driver: local
    redis-data:
        driver: local
